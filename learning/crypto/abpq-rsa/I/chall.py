from Crypto.Util.number import getPrime, bytes_to_long
from random import randint
import math

p = getPrime(1024)
q = getPrime(1024)
n = p * q
e = 0x10001

hints = []
for _ in range(2):
    a, b = randint(0, 2**12), randint(0, 2**312)
    hints.append(a * p + b * q)

#FLAG = open('flag.txt', 'rb').read().strip()
#c = pow(bytes_to_long(FLAG), e, n)
#print(f'{n = }')
#print(f'{c = }')
#print(f'{hints = }')
n = 14660571735908952489002993827903664741357457851760908649720903490242781200599279200941555625377480322300761434214784243355865531476885778933049205035635857511724445636189412010232288883997962334374976967072473569268104938242162374146303713780734432405002257811743659454802783820254267629648005198676228493220090910570651981720956782436579563383210521881408697895574988998166073088181182460781625583449895170069416296911080037108242200943819190329592722210240372478763827674403639468179156438805357971476738826284179397702996711111034575635088841241354137431691608708586537071546432546205216081312804647066737570894023
c = 3014228465839024222531913178876755997202579066571946568117957620992626184075072645592929274030475721860516337363549964023809640935927422141596369521625373032887992171544987963053649222268839362296140298254567557247243959631873642653628768056590251288717876967238844363668216669345111199235366782491099628442127257864721021039424850656858549634126388057122624827577450574032676846584352473272792426900482052166907296663510940614653937816719545779923761921955012981313093729997041764588048873232122578759116941501754753461228949083630697583974029795241994896139613416128261382360080426690047897663352151650683784366653
hints = [67585409877128467394273747844708023711838736622300021631288299732185049081526590070916229113028139589562794761992161702552127144257559125951801065743849636934249630981744074216493369003468402441168300904480336834940777808019851079394816890016422575441233207435464900093733380879874842695796266071203345796326004992321513696172431553195641602978421349425073721183337173252205696314692954319121838740596, 782369796451936135579812610738083472168315963073406077738956209771703291533885768715713836864555818764933142195016274849912821793067896876879775874626375680114617513069518529094752988467057235780327327874593431997790580089256851961020111777818708980408558380525792906243767981446549436960403836084157427542914546700430818824224973669530677353137795028589982623354988306696364282934565224135139011055012]

# a1p + b1q = h1
# a2p + b2q = h2

# a1a2p + a2b1q = a2h1
# a2a1p + a1b2q = a1h2

# R = a2h1 - a1h2 = q(a2b1 - a1b2)

# gcd(R, n) = q

h1 = hints[0]
h2 = hints[1]

# Search bounds for a are 0..2^12-1
MAX_A = 2**12

print("Starting brute-force search for small a1,a2 (0..4095). This may take a little while.")

found = False
for a1 in range(MAX_A):
    # optional small micro-optimisation: precompute multiples of h1? not necessary
    for a2 in range(MAX_A):
        R = a2 * h1 - a1 * h2
        # gcd of R and n may reveal q or p
        g = math.gcd(R, n)
        if 1 < g < n:
            print("Found non-trivial gcd!")
            print("a1 =", a1, "a2 =", a2)
            print("factor g =", g)
            p = g
            q = n // g
            # ensure p < q
            if p > q:
                p, q = q, p
            print("p bitlen:", p.bit_length(), "q bitlen:", q.bit_length())
            # compute private exponent
            phi = (p - 1) * (q - 1)
            e = 0x10001
            try:
                d = pow(e, -1, phi)
            except TypeError:
                # Python < 3.8 fallback
                d = pow(e, -1, phi)
            m = pow(c, d, n)
            try:
                flag = long_to_bytes(m).rstrip(b"\x00")
            except Exception:
                # fallback hex conversion
                s = hex(m)[2:]
                if len(s) % 2:
                    s = '0' + s
                flag = bytes.fromhex(s)
            print("FLAG (raw):", flag)
            try:
                print("FLAG (utf-8):", flag.decode())
            except:
                pass
            found = True
            break
    if found:
        break

if not found:
    print("No factor found in the searched a1,a2 range. Consider increasing search range or checking inputs.")
